name: mac-app-build-action
# æ¨é€Tagæ—¶è§¦å‘
on:
  push:
    tags:
      - "v*"
jobs:
  build-mac-app: # ä½œä¸šåç§°ä¿®æ”¹ä¸ºæ›´å…·ä½“
    runs-on: macos-latest
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release
    steps:
      # ç­¾å‡ºä»£ç 
      - uses: actions/checkout@v4
        # æ³¨æ„ï¼šå¦‚æœä½ çš„ç‰ˆæœ¬ä¿¡æ¯æˆ–ä»£ç åœ¨ master åˆ†æ”¯ï¼Œè¿™é‡Œä¿æŒ ref: master æ˜¯å¯¹çš„
        # å¦‚æœç‰ˆæœ¬ä¿¡æ¯éš tag èµ°ï¼Œå¯ä»¥ç§»é™¤ ref: masterï¼Œè®© action è‡ªåŠ¨ç­¾å‡ºè§¦å‘çš„ tag
        with:
          ref: master # æˆ–è€…ç§»é™¤è¿™è¡Œï¼Œç­¾å‡ºè§¦å‘äº‹ä»¶çš„ tag

      # è®¾ç½®Flutter
      - name: Flutter action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x' # ä¿æŒä¸åŸé…ç½®ä¸€è‡´çš„Flutterç‰ˆæœ¬
          cache: true

      # æ‰“å¼€MAC Desktopæ”¯æŒ
      - name: Enable Flutter Desktop
        run: flutter config --enable-macos-desktop

      # æ›´æ–°Flutterçš„packages
      - name: Restore packages
        # å‡è®¾ä½ çš„ flutter é¡¹ç›®åœ¨ simple_live_app ç›®å½•ä¸‹
        run: |
          cd simple_live_app
          flutter pub get

      # å®‰è£… appdmg (ç”¨äº flutter_distributor æ‰“åŒ… dmg)
      - name: Install appdmg
        run: npm install -g appdmg

      # è®¾ç½® flutter_distributor ç¯å¢ƒ
      - name: Install flutter_distributor
        run: dart pub global activate flutter_distributor

      # æ‰“åŒ…MAC
      - name: Build MacOS
        run: |
          cd simple_live_app
          flutter_distributor package --platform macos --targets dmg,zip --skip-clean

      # ä¸Šä¼ MACæ„å»ºäº§ç‰©è‡³Artifacts (æ–¹ä¾¿è°ƒè¯•æˆ–æ£€æŸ¥)
      - name: Upload MacOS Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-build-output # Artifact åç§°
          path: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      # è¯»å–ç‰ˆæœ¬ä¿¡æ¯ (å‡è®¾ç‰ˆæœ¬æ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•ä¸‹çš„ assets/app_version.json)
      # å¦‚æœæ–‡ä»¶åœ¨ simple_live_app ä¸‹ï¼Œè·¯å¾„åº”ä¸º simple_live_app/assets/app_version.json
      - name: Read version
        id: version
        uses: juliangruber/read-file-action@v1
        with:
          # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹è·¯å¾„
          path: simple_live_app/assets/app_version.json # ç¡®è®¤æ–‡ä»¶è·¯å¾„

      - name: Echo version info (for debugging)
        run: |
          echo "Version: ${{ fromJson(steps.version.outputs.content).version }}"
          echo "Prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}"
          echo "Description: ${{ fromJson(steps.version.outputs.content).version_desc }}"


      # ä¸Šä¼ è‡³Release
      - name: Upload MacOS Release Assets
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨ä»æ–‡ä»¶ä¸­è¯»å–çš„ç‰ˆæœ¬ä¿¡æ¯
          name: "Release ${{ fromJson(steps.version.outputs.content).version }}"
          body: "${{ fromJson(steps.version.outputs.content).version_desc }}"
          prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}
          token: ${{ secrets.TOKEN }} # ç¡®ä¿ä½ çš„ä»“åº“æœ‰è¿™ä¸ªåä¸º TOKEN çš„ secret
          # åªä¸Šä¼  macOS çš„æ„å»ºäº§ç‰©
          files: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      # å®Œæˆ
      - name: Job Completion Status
        run: echo "ğŸ MacOS build job finished with status ${{ job.status }}."
